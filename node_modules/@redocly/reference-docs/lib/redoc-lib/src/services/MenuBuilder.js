"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.MenuBuilder=exports.GROUP_DEPTH=void 0;var tslib_1=require("tslib"),utils_1=require("../utils"),MarkdownRenderer_1=require("./MarkdownRenderer"),models_1=require("./models");exports.GROUP_DEPTH=0;var MenuBuilder=function(){function e(){}return Object.defineProperty(e,"buildStructure",{enumerable:!1,configurable:!0,writable:!0,value:function(r,t){var a=r.definition,n=[],i=(0,tslib_1.__spreadArray)([],a.tags||[],!0)||[];!i.find((function(e){return(null==e?void 0:e.name)===t.schemaDefinitionsTagName}))&&t.schemaDefinitionsTagName&&i.push({name:t.schemaDefinitionsTagName});var s=e.getTagsWithOperations(r,i),o=a["x-tagGroups"];return n.push.apply(n,e.addMarkdownItems(a.info.description||"",void 0,1,t)),o&&o.length>0?n.push.apply(n,e.getTagGroupsItems(r,void 0,o,s,t)):n.push.apply(n,e.getTagsItems(r,s,void 0,void 0,t)),n}}),Object.defineProperty(e,"addMarkdownItems",{enumerable:!1,configurable:!0,writable:!0,value:function(e,r,t,a){var n=new MarkdownRenderer_1.MarkdownRenderer(a).extractHeadings(e||"");n.length&&r&&r.description&&(r.description=MarkdownRenderer_1.MarkdownRenderer.getTextBeforeHading(r.description,n[0].name));var i=function(e,r,t){return void 0===t&&(t=1),r.map((function(r){var a=new models_1.GroupModel("section",r,e);return a.depth=t,r.items&&(a.items=i(a,r.items,t+1)),a}))};return i(r,n,t)}}),Object.defineProperty(e,"getTagGroupsItems",{enumerable:!1,configurable:!0,writable:!0,value:function(r,t,a,n,i){for(var s=[],o=0,l=a;o<l.length;o++){var u=l[o],p=new models_1.GroupModel("group",u,t);p.depth=exports.GROUP_DEPTH,p.items=e.getTagsItems(r,n,p,u,i),s.push(p)}return s}}),Object.defineProperty(e,"getTagsItems",{enumerable:!1,configurable:!0,writable:!0,value:function(r,t,a,n,i){var s;if(s=void 0===n?Object.keys(t):n.tags,!Array.isArray(s))return console.warn("Unexpected values of tags. Check tags or x-tagGroups in your definition."),[];for(var o=[],l=0,u=s.map((function(e){return t[e]?(t[e].used=!0,t[e]):(console.warn('Non-existing tag "'+e+'" is added to the group "'+(null==n?void 0:n.name)+'"'),null)}));l<u.length;l++){var p=u[l];if(p){var d=new models_1.GroupModel("tag",p,a);if(d.depth=exports.GROUP_DEPTH+1,""!==p.name){var m=this.getTagRelatedSchema({parser:r,tag:p,parent:d,schemaDefinitionsTagName:i.schemaDefinitionsTagName});d.items=(0,tslib_1.__spreadArray)((0,tslib_1.__spreadArray)((0,tslib_1.__spreadArray)([],m,!0),e.addMarkdownItems(p.description||"",d,d.depth+1,i),!0),this.getOperationsItems(r,d,p,d.depth+1,i),!0),o.push(d)}else{var c=(0,tslib_1.__spreadArray)((0,tslib_1.__spreadArray)([],e.addMarkdownItems(p.description||"",d,d.depth+1,i),!0),this.getOperationsItems(r,void 0,p,d.depth+1,i),!0);o.push.apply(o,c)}}}return i.sortTagsAlphabetically&&o.sort((0,utils_1.alphabeticallyByProp)("name")),o}}),Object.defineProperty(e,"getTagRelatedSchema",{enumerable:!1,configurable:!0,writable:!0,value:function(e){var r,t=e.parser,a=e.tag,n=e.parent,i=e.schemaDefinitionsTagName,s=i?[i]:[];return Object.entries((null===(r=t.definition.components)||void 0===r?void 0:r.schemas)||{}).map((function(e){var r=e[0],t=e[1];if(!(t["x-tags"]||s).includes(a.name))return null;var i=new models_1.GroupModel("schema",{name:r,"x-displayName":""+(t.title||r),description:'<SchemaDefinition showWriteOnly={true} schemaRef="#/components/schemas/'+r+'" />',isSchema:!0,level:2},n);return i.depth=n.depth+1,i})).filter(Boolean)}}),Object.defineProperty(e,"getOperationsItems",{enumerable:!1,configurable:!0,writable:!0,value:function(e,r,t,a,n){if(0===t.operations.length)return[];for(var i=[],s=0,o=t.operations;s<o.length;s++){var l=o[s],u=new models_1.OperationModel(e,l,r,n);u.depth=a,i.push(u)}return n.sortOperationsAlphabetically&&i.sort((0,utils_1.alphabeticallyByProp)("name")),i}}),Object.defineProperty(e,"getTagsWithOperations",{enumerable:!1,configurable:!0,writable:!0,value:function(e,r){for(var t={},a=e.definition,n=a["x-webhooks"]||a.webhooks,i=0,s=r||[];i<s.length;i++){var o=s[i];t[o.name]=(0,tslib_1.__assign)((0,tslib_1.__assign)({},o),{operations:[]})}function l(e,r,a){for(var n,i=0,s=Object.keys(r||{});i<s.length;i++)for(var o=s[i],u=r[o],p=0,d=Object.keys(u).filter(utils_1.isOperationName);p<d.length;p++){var m=d[p],c=u[m];if(u.$ref){var g=e.deref(u);l(e,((n={})[o]=g,n),a)}else{var h=null==c?void 0:c.tags;h&&h.length||(h=[""]);for(var f=0,v=h;f<v.length;f++){var b=v[f],_=t[b];void 0===_&&(_={name:b,operations:[]},t[b]=_),_["x-traitTag"]||_.operations.push((0,tslib_1.__assign)((0,tslib_1.__assign)({},c),{pathName:o,pointer:utils_1.JsonPointer.compile(["paths",o,m]),httpVerb:m,pathParameters:u.parameters||[],pathServers:u.servers,isWebhook:!!a}))}}}}return a.paths&&l(e,a.paths),n&&l(e,n,!0),t}}),e}();exports.MenuBuilder=MenuBuilder;
//# sourceMappingURL=MenuBuilder.js.map