"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.isHostAllowed=void 0;var tslib_1=require("tslib"),utils_1=require("./utils");function promisifyIECryptoRes(e){return"then"in e?e:new Promise((function(t){e.oncomplete=function(e){t(e.target.result)}}))}function str2ab(e){for(var t=new ArrayBuffer(e.length),r=new Uint8Array(t),n=0,i=e.length;n<i;n++)r[n]=e.charCodeAt(n);return t}var getKey=function(){var e,t=str2ab(atob("undefined"!=typeof REDOCLY_PUBLIC_KEY?REDOCLY_PUBLIC_KEY:"MFwwDQYJKoZIhvcNAQEBBQADSwAwSAJBAMHjNir5fXx/ZXoaEeXQ5XyxbNJ4YJYczoCRdSkL6NLzw1FHnng5Vfcgk5+bvox9QRYRbuk84mA4f2NhywDbXKECAwEAAQ=="));return promisifyIECryptoRes(null===(e=utils_1.cryptoLib)||void 0===e?void 0:e.subtle.importKey("spki",t,{name:"RSASSA-PKCS1-v1_5",hash:"SHA-256"},!0,["verify"]))};function textEncode(e){if(window.TextEncoder)return(new TextEncoder).encode(e);for(var t=unescape(encodeURIComponent(e)),r=new Uint8Array(t.length),n=0;n<t.length;n++)r[n]=t.charCodeAt(n);return r}function verify(e,t){var r;return(0,tslib_1.__awaiter)(this,void 0,void 0,(function(){var n,i,o,s,a;return(0,tslib_1.__generator)(this,(function(l){switch(l.label){case 0:return n=promisifyIECryptoRes,null!==(r=utils_1.cryptoLib)&&void 0!==r?[3,1]:(i=void 0,[3,3]);case 1:return s=(o=r.subtle).verify,a=[{name:"RSASSA-PKCS1-v1_5",hash:"SHA-256"}],[4,getKey()];case 2:i=s.apply(o,a.concat([l.sent(),str2ab(atob(t)),textEncode(e)])),l.label=3;case 3:return[2,n.apply(void 0,[i])]}}))}))}function isHostAllowed(e,t){return!0===t||!(!Array.isArray(t)||"undefined"==typeof window)&&(!("localhost"!==e&&"127.0.0.1"!==e&&!e.endsWith(".localhost")&&!t.find((function(t){return t===e||e.endsWith("."+t)})))||!!t.find((function(t){if(t.indexOf("*")===t.lastIndexOf("*")){var r=t.split("*"),n=r[0],i=r[1];return i&&e.startsWith(n)&&e.endsWith(i)&&i.split(".").length>2}})))}function parse(e){return(0,tslib_1.__awaiter)(this,void 0,void 0,(function(){var t,r,n,i,o;return(0,tslib_1.__generator)(this,(function(s){switch(s.label){case 0:if("development"===process.env.NODE_ENV)return[2,{valid:!0,allowed:!0}];if(t=window.location.hostname,!e)return"localhost"===t||"127.0.0.1"===t||t.endsWith(".localhost")?[2,{local:!0}]:[2,{}];r=e.split("."),n=r[0],i=r[1],s.label=1;case 1:return s.trys.push([1,3,,4]),[4,verify(atob(n),i)];case 2:return s.sent()?(o=JSON.parse(atob(n)),[3,4]):[2,{valid:!1}];case 3:return s.sent(),[2,{valid:!1,cryptoMissing:!0}];case 4:return o.valid=!0,(!o.e||Date.now()/1e3>o.e)&&(o.expired=!0),o.allowed=isHostAllowed(t,o.h),[2,o]}}))}))}exports.isHostAllowed=isHostAllowed,exports.default=parse;
//# sourceMappingURL=check.js.map