import{__assign,__spreadArray}from"tslib";import{isOperationName,JsonPointer,alphabeticallyByProp}from"../utils";import{MarkdownRenderer}from"./MarkdownRenderer";import{GroupModel,OperationModel}from"./models";export var GROUP_DEPTH=0;var MenuBuilder=function(){function e(){}return Object.defineProperty(e,"buildStructure",{enumerable:!1,configurable:!0,writable:!0,value:function(r,a){var t=r.definition,n=[],i=__spreadArray([],t.tags||[],!0)||[];!i.find((function(e){return(null==e?void 0:e.name)===a.schemaDefinitionsTagName}))&&a.schemaDefinitionsTagName&&i.push({name:a.schemaDefinitionsTagName});var o=e.getTagsWithOperations(r,i),s=t["x-tagGroups"];return n.push.apply(n,e.addMarkdownItems(t.info.description||"",void 0,1,a)),s&&s.length>0?n.push.apply(n,e.getTagGroupsItems(r,void 0,s,o,a)):n.push.apply(n,e.getTagsItems(r,o,void 0,void 0,a)),n}}),Object.defineProperty(e,"addMarkdownItems",{enumerable:!1,configurable:!0,writable:!0,value:function(e,r,a,t){var n=new MarkdownRenderer(t).extractHeadings(e||"");n.length&&r&&r.description&&(r.description=MarkdownRenderer.getTextBeforeHading(r.description,n[0].name));var i=function(e,r,a){return void 0===a&&(a=1),r.map((function(r){var t=new GroupModel("section",r,e);return t.depth=a,r.items&&(t.items=i(t,r.items,a+1)),t}))};return i(r,n,a)}}),Object.defineProperty(e,"getTagGroupsItems",{enumerable:!1,configurable:!0,writable:!0,value:function(r,a,t,n,i){for(var o=[],s=0,p=t;s<p.length;s++){var l=p[s],d=new GroupModel("group",l,a);d.depth=GROUP_DEPTH,d.items=e.getTagsItems(r,n,d,l,i),o.push(d)}return o}}),Object.defineProperty(e,"getTagsItems",{enumerable:!1,configurable:!0,writable:!0,value:function(r,a,t,n,i){var o;if(o=void 0===n?Object.keys(a):n.tags,!Array.isArray(o))return console.warn("Unexpected values of tags. Check tags or x-tagGroups in your definition."),[];for(var s=[],p=0,l=o.map((function(e){return a[e]?(a[e].used=!0,a[e]):(console.warn('Non-existing tag "'+e+'" is added to the group "'+(null==n?void 0:n.name)+'"'),null)}));p<l.length;p++){var d=l[p];if(d){var u=new GroupModel("tag",d,t);if(u.depth=GROUP_DEPTH+1,""!==d.name){var m=this.getTagRelatedSchema({parser:r,tag:d,parent:u,schemaDefinitionsTagName:i.schemaDefinitionsTagName});u.items=__spreadArray(__spreadArray(__spreadArray([],m,!0),e.addMarkdownItems(d.description||"",u,u.depth+1,i),!0),this.getOperationsItems(r,u,d,u.depth+1,i),!0),s.push(u)}else{var c=__spreadArray(__spreadArray([],e.addMarkdownItems(d.description||"",u,u.depth+1,i),!0),this.getOperationsItems(r,void 0,d,u.depth+1,i),!0);s.push.apply(s,c)}}}return i.sortTagsAlphabetically&&s.sort(alphabeticallyByProp("name")),s}}),Object.defineProperty(e,"getTagRelatedSchema",{enumerable:!1,configurable:!0,writable:!0,value:function(e){var r,a=e.parser,t=e.tag,n=e.parent,i=e.schemaDefinitionsTagName,o=i?[i]:[];return Object.entries((null===(r=a.definition.components)||void 0===r?void 0:r.schemas)||{}).map((function(e){var r=e[0],a=e[1];if(!(a["x-tags"]||o).includes(t.name))return null;var i=new GroupModel("schema",{name:r,"x-displayName":""+(a.title||r),description:'<SchemaDefinition showWriteOnly={true} schemaRef="#/components/schemas/'+r+'" />',isSchema:!0,level:2},n);return i.depth=n.depth+1,i})).filter(Boolean)}}),Object.defineProperty(e,"getOperationsItems",{enumerable:!1,configurable:!0,writable:!0,value:function(e,r,a,t,n){if(0===a.operations.length)return[];for(var i=[],o=0,s=a.operations;o<s.length;o++){var p=s[o],l=new OperationModel(e,p,r,n);l.depth=t,i.push(l)}return n.sortOperationsAlphabetically&&i.sort(alphabeticallyByProp("name")),i}}),Object.defineProperty(e,"getTagsWithOperations",{enumerable:!1,configurable:!0,writable:!0,value:function(e,r){for(var a={},t=e.definition,n=t["x-webhooks"]||t.webhooks,i=0,o=r||[];i<o.length;i++){var s=o[i];a[s.name]=__assign(__assign({},s),{operations:[]})}function p(e,r,t){for(var n,i=0,o=Object.keys(r||{});i<o.length;i++)for(var s=o[i],l=r[s],d=0,u=Object.keys(l).filter(isOperationName);d<u.length;d++){var m=u[d],c=l[m];if(l.$ref){var g=e.deref(l);p(e,((n={})[s]=g,n),t)}else{var h=null==c?void 0:c.tags;h&&h.length||(h=[""]);for(var f=0,v=h;f<v.length;f++){var b=v[f],y=a[b];void 0===y&&(y={name:b,operations:[]},a[b]=y),y["x-traitTag"]||y.operations.push(__assign(__assign({},c),{pathName:s,pointer:JsonPointer.compile(["paths",s,m]),httpVerb:m,pathParameters:l.parameters||[],pathServers:l.servers,isWebhook:!!t}))}}}}return t.paths&&p(e,t.paths),n&&p(e,n,!0),a}}),e}();export{MenuBuilder};
//# sourceMappingURL=MenuBuilder.js.map