"use strict";const visit=require(`unist-util-visit`),isRelativeUrl=require(`is-relative-url`),fsExtra=require(`fs-extra`),path=require(`path`),_=require(`lodash`),cheerio=require(`cheerio`),imageSize=require(`probe-image-size`),RBAC=require("../gatsby-source-redocly-filesystem/rbac"),DEPLOY_DIR=`public`,invalidDestinationDirMessage=a=>`[gatsby-remark-copy-linked-files]: You have supplied an invalid destination directory. The destination directory must be a child but was: ${a}`,destinationIsValid=a=>!path.relative(`./`,a).startsWith(`..`),validateDestinationDir=a=>`undefined`==typeof a||(`string`==typeof a?destinationIsValid(`${a}/h/n`):!!_.isFunction(a)&&destinationIsValid(`${a({name:`n`,hash:`h`})}`)),defaultDestination=a=>`${a.internal.contentDigest}/${a.name}.${a.extension}`,getDestination=(a,b)=>{if(_.isFunction(b)){const c=`${b({})}`!=`${b({name:`n`,hash:`h`})}`;return c?`${b({name:a.name,hash:a.internal.contentDigest})}.${a.extension}`:`${b()}/${defaultDestination(a)}`}return _.isString(b)?`${b}/${defaultDestination(a)}`:defaultDestination(a)},newPath=(a,b)=>{const{destinationDir:c}=b,d=getDestination(a,c),e=[process.cwd(),DEPLOY_DIR,d];return path.posix.join(...e)},newLinkURL=(a,b,c)=>{const{destinationDir:d}=b,e=getDestination(a,d);return`${c?c:``}/${e}`};function toArray(a){const b=Array(a.length);for(let c=0;c<a.length;c++)b[c]=a[c];return b}module.exports=({files:a,markdownNode:b,markdownAST:c,pathPrefix:d,getNode:e},f={})=>{const{destinationDir:g}=f;if(!validateDestinationDir(g))return Promise.reject(invalidDestinationDirMessage(g));const h=_.defaults({},f,{ignoreFileExtensions:[`png`,`jpg`,`jpeg`,`bmp`,`tiff`]}),i=new Map,j=c=>{if(isRelativeUrl(c.url)&&`File`===e(b.parent).internal.type){const f=path.posix.join(e(b.parent).dir,c.url),g=_.find(a,a=>a&&a.absolutePath?a.absolutePath===f:null);if(g&&g.absolutePath){const a=newPath(g,h);if(f===a)return;h.hasOwnProperty("configPath")&&(RBAC.RBACConfig[path.relative(path.join(process.cwd(),DEPLOY_DIR),a)]=RBAC.getDirectoryPermission(h.configPath,path.dirname(b.fileAbsolutePath))),c.url=newLinkURL(g,h,d),i.set(f,a)}}},k=function(c,d){const f=path.posix.join(e(b.parent).dir,c.attr(`src`)),g=_.find(a,a=>a&&a.absolutePath?a.absolutePath===f:null);if(!g||!g.absolutePath)return;const h=c.attr(`src`),i={url:c.attr(`src`)};j(i),d.value=d.value.replace(new RegExp(c.attr(`src`),`g`),i.url);let k;c.attr(`width`)&&c.attr(`height`)||(k=imageSize.sync(toArray(fsExtra.readFileSync(g.absolutePath))));const l=h.split(`/`),m=l[l.length-1],n=m.replace(/\.[^/.]+$/,``),o=n.replace(/[^A-Z0-9]/gi,` `);c.attr(`alt`,c.attr(`alt`)?c.attr(`alt`):o),c.attr(`width`,c.attr(`width`)?c.attr(`width`):k.width),c.attr(`height`,c.attr(`height`)?c.attr(`height`):k.height)};return visit(c,`link`,a=>{const b=a.url.split(`.`).pop();h.ignoreFileExtensions.includes(b)||j(a)}),visit(c,`definition`,a=>{const b=a.url.split(`.`).pop();h.ignoreFileExtensions.includes(b)||j(a)}),visit(c,`image`,c=>{const d=c.url.split(`.`).pop();if(h.ignoreFileExtensions.includes(d))return;if(b.parent&&`File`!==e(b.parent).internal.type)return;const f=path.posix.join(e(b.parent).dir,c.url),g=_.find(a,a=>!!(a&&a.absolutePath)&&a.absolutePath===f);g&&j(c)}),visit(c,[`html`,`jsx`],a=>{function b({url:b,isRequired:c}){try{const d=b.split(`.`).pop();if(!h.ignoreFileExtensions.includes(d)||c){const c={url:b};j(c),a.value=a.value.replace(new RegExp(b,`g`),c.url)}}catch(a){}}function c(a,b){return a.map(function(){const a=d(this),c=d(this).attr(b);return c&&isRelativeUrl(c)?{url:c,element:a}:void 0}).toArray().filter(Boolean)}const d=cheerio.load(a.value);return c(d(`img[src]`),`src`).forEach(({url:b,element:c})=>{try{const d=b.split(`.`).pop();h.ignoreFileExtensions.includes(d)||k(c,a)}catch(a){}}),c(d(`video source[src], video[src]`),`src`).forEach(b),c(d(`video[poster]`),`poster`).forEach(a=>b({...a,isRequired:!0})),c(d(`audio source[src], audio[src]`),`src`).forEach(b),c(d(`object param[value]`),`value`).forEach(b),void c(d(`a[href]`),`href`).forEach(b)}),Promise.all(Array.from(i,async([a,b])=>{if(!fsExtra.existsSync(b))try{await fsExtra.ensureDir(path.dirname(b)),await fsExtra.copy(a,b)}catch(a){console.error(`error copying file`,a)}}))};