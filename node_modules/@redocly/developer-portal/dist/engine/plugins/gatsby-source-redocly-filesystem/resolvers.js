const chalk=require("chalk"),fs=require("fs"),path=require("path"),{execute,parse}=require("graphql"),RBAC=require("./rbac"),{getRedocStoreById}=require("./oas/cache"),{YAML_PAGE_EXTENSION,copyFile,copyReferencedFiles,isAllowedOasFile}=require("./utils"),{getPageInfo,getAllPagesInfo,getPageInfoByDefinitionId}=require("./pages/cache"),{PAGE_TYPES}=require("../../constants"),{getResolvedApis}=require("./catalog");function linkMatcher(a){return b=>b===a||b.startsWith(a+"/")}exports.createResolvers=(a,b)=>{function c(a){const b=getPageInfo(a);return b&&b.link||null}const{defaultRbacPermission:d}=b.getSiteConfig(),e=b.configPath;a.createResolvers({ContentItemSeo:{image:{resolve:(b,c,d)=>{if(!b.image)return"";const f=copyReferencedFiles(b,{context:d,...a},e,e);return f.image}}},ContentItemData:{customDataString:{resolve:(b,c,d)=>{if(!b.sourcePath)return b.customDataString||"";if(!b.customDataString)return"";const f=JSON.parse(b.customDataString),{sidebar:g,...h}=f,i=copyReferencedFiles(h,{context:d,...a},path.dirname(b.sourcePath),e);return JSON.stringify({...i,sidebar:g})}}},Query:{apis:{resolve:(a,b)=>{let c=getAllPagesInfo().filter(a=>a.type===PAGE_TYPES.referenceDocsContainerPage);b.ignoreRBAC||"development"===process.env.NODE_ENV||(c=c.filter(a=>{const b=a.permission||RBAC.GUEST_PERMISSION;return b===RBAC.GUEST_PERMISSION}));const e=[...(b.definitionProperties||[]),"x-categories","x-tags"],f=c.filter(a=>a.isDefaultApiVersion).map(a=>{const b=a.apiVersions.find(a=>a.isDefault).definitionId,f=getRedocStoreById(b),g=f&&f.redocStore.definition.parser.definition;if(!g)return null;const h=e.reduce((a,b)=>(a[b]=g[b],a),{});return{id:a.id,definitionId:b,versions:a.apiVersions.map(b=>{const d=c.find(c=>c.apiVersionId===b.id&&c.pageId.split("@")[0]===a.pageId.split("@")[0]);return{...b,link:d&&d.link}}),sourcePath:a.sourcePath,link:a.link,info:g.info,title:a.title||a.label||g.info.title,definitionProperties:h,permission:a.permission||d,data:{...a.rawData,redocStore:void 0,redocMenuItems:void 0,redocItemId:void 0,customDataString:void 0,customTemplate:void 0,requestLogin:void 0}}}).filter(Boolean);return f.sort((c,a)=>c&&a&&c.definitionId.localeCompare(a.definitionId)),f}},oasDefinition:{resolve:(a,b)=>{const c=getRedocStoreById(b.id);return{...c,redocStore:c&&c.redocStoreStr}}},apiCatalog:{resolve:async(a,{ignoreRBAC:b},c,d)=>{const e=getResolvedApis(),f=await execute({schema:d.schema,document:parse(`{
              allSidebar {
                nodes {
                  pagesLinks
                  name
                }
              }
            }`),contextValue:c,rootValue:null}),g=f.data.allSidebar.nodes.flatMap(a=>a.pagesLinks),h="development"===process.env.NODE_ENV||b;return e.map(a=>({...a,link:g.find(linkMatcher(a.pathPrefix)),versions:a.versions.map(a=>({...a,link:g.find(linkMatcher(a.pathPrefix))})),defaultVersion:{...a.defaultVersion,link:g.find(linkMatcher(a.defaultVersion.pathPrefix))}})).filter(a=>h||a.permission===RBAC.GUEST_PERMISSION)}}},ApiCatalogVersion:{metadata:{resolve:(b,c,d)=>{const f=copyReferencedFiles(b.metadata,{context:d,...a},path.join(e,b.versionRelativePath),e);return f}}},SiteSiteMetadata:{image:{resolve:(b,c,d)=>{const f=b.image;return copyFile(f,{context:d,...a},e,e)}}},SiteConfig:{footer:{resolve:a=>a.raw.footer},logo:{resolve:(b,c,d)=>{const f=b.raw.logo||{},g=b.raw.seo||{},h="string"==typeof f;b.raw.headerIcon&&console.warn("\"headerIcon\" is deprecated, use it inside the \"logo.image\" instead"),g.logoHref&&console.warn("\"logoHref\" is deprecated, use it inside the \"logo.href\" instead"),g.logoAltText&&console.warn("\"logoAltText\" is deprecated, use it inside the \"logo.altText\" instead"),h&&console.warn("\"logo\" as a string is deprecated, use it inside the \"logo.image\" instead");const i=f.image||h&&f||b.raw.headerIcon;return{image:copyFile(i,{context:d,...a},e,e),href:f.href||g.logoHref||"/",altText:f.altText||g.logoAltText}}},editPage:{resolve:(b,c,d)=>{const f=b.raw.editPage||{};return{baseUrl:f.baseUrl,text:f.text,icon:copyFile(f.icon,{context:d,...a},e,e)}}},scripts:{resolve:(b,c,d)=>{const f=b.raw.scripts||[];return f.map(b=>copyFile(b,{context:d,...a},e,e)).filter(a=>!!a)}},nav:{resolve:(a,{ignoreRBAC:b})=>a.raw.nav?a.raw.nav.filter(a=>{const c=getPageInfo(a.page),e=a.page&&c?getPageInfo(a.page).permission:void 0,f=a.permission||e||d,g="development"===process.env.NODE_ENV||b;return g||f===RBAC.GUEST_PERMISSION}):[]},enableToc:{resolve:a=>a.raw.enableToc||!1},disableLastModified:{resolve:a=>a.raw.disableLastModified||!1},tocMaxDepth:{resolve:a=>a.raw.tocMaxDepth||4},toc:{resolve:a=>({enable:a.raw.toc&&a.raw.toc.hasOwnProperty("enable")?a.raw.toc.enable:a.raw.enableToc||!1,maxDepth:a.raw.toc&&a.raw.toc.hasOwnProperty("maxDepth")?a.raw.toc.maxDepth:a.raw.tocMaxDepth||4,headings:[]})},seo:{resolve:a=>a.raw.seo||null}},FooterConfig:{links:{resolve:a=>filterSerachItems(a.links)},columns:{resolve:(a,{ignoreRBAC:b})=>{const c="development"===process.env.NODE_ENV||b;return a.columns?a.columns.filter(a=>c||!a.permission||a.permission===RBAC.GUEST_PERMISSION):[]}}},FooterColumn:{permission:{resolve:a=>a.permission||d},group:{resolve:a=>a.group},items:{resolve:(a,{ignoreRBAC:b})=>filterSerachItems(a.items).filter(a=>{const c=getPageInfo(a.page),e=a.page&&c?c.permission:void 0,f=a.permission||e||d,g="development"===process.env.NODE_ENV||b;return g||f===RBAC.GUEST_PERMISSION})}},Sidebar:{context:{resolve:(b,c,d)=>{if(!b.context)return"";const f=JSON.parse(b.context),g=copyReferencedFiles(f,{context:d,...a},e,e);return JSON.stringify(g)}},permission:{resolve:a=>a.permission||d},pagesIds:{resolve:async c=>{const e=await expandItems(Array.isArray(c)?c:c.pages,a.reporter,d,b);return extractSidebarIds(e)}},pagesLinks:{resolve:async e=>{const f=await expandItems(Array.isArray(e)?e:e.pages,a.reporter,d,b),g=extractSidebarIds(f),h=g.map(c).filter(Boolean);return h}},items:{resolve:async(c,{ignoreRBAC:e})=>{const f=await expandItems(Array.isArray(c)?c:c.pages,a.reporter,d,b),g="development"===process.env.NODE_ENV||e;return f.map(a=>removePrivateSidebarItems(a,g)).filter(a=>!!a)}}},NavItem:{redocPrevLink:{resolve:a=>{if(a.page){const b=getPageInfo(a.page);return b&&b.redocPrevLink||null}if(a.redocFakePage&&a.parentPageId){const b=getPageInfo(a.parentPageId);return b&&b.redocPrevLink||null}}},redocPrevLabel:{resolve:a=>{if(a.page){const b=getPageInfo(a.page);return b&&b.redocPrevLabel||null}if(a.redocFakePage&&a.parentPageId){const b=getPageInfo(a.parentPageId);return b&&b.redocPrevLabel||null}}},redocNextLink:{resolve:a=>{if(a.page){const b=getPageInfo(a.page);return b&&b.redocNextLink||null}if(a.redocFakePage&&a.parentPageId){const b=getPageInfo(a.parentPageId);return b&&b.redocNextLink||null}}},redocNextLabel:{resolve:a=>{if(a.page){const b=getPageInfo(a.page);return b&&b.redocNextLabel||null}if(a.redocFakePage&&a.parentPageId){const b=getPageInfo(a.parentPageId);return b&&b.redocNextLabel||null}}},pageId:{resolve:a=>{if(a.apiId){const b=a.page||a.parentPageId;return a.apiId+"#"+b.split("#")[1]}return a.page||a.parentPageId}},activateWithSidebar:{resolve:a=>a.activateWithSidebar},label:{resolve:a=>{if(a.label)return a.label;if(a.group)return a.group;if(a.page){const b=getPageInfo(a.page);return b&&b.label||`<${a.page}>`}return a.separator?"string"==typeof a.separator?a.separator:"":""}},link:{resolve:a=>{if(a.link)return a.link;if(a.href)return a.href;if(a.page){const b=getPageInfo(a.page);return b&&b.link||null}}},icon:{resolve:(c,d,f)=>{if(c.icon)return fs.existsSync(path.resolve(b.configPath,c.icon))?copyFile(c.icon,{context:f,...a},e,e):c.icon}},httpVerb:{resolve:a=>{if(a.httpVerb)return a.httpVerb;if(a.page){const b=getPageInfo(a.page);return b&&b.httpVerb||null}}},permission:{resolve:a=>a.permission?a.permission:getPageInfo(a.page)?getPageInfo(a.page).permission:d},type:{resolve:a=>a.href?"href":a.page?"page":a.search?"search":a.group?"group":a.separator?"separator":a.separatorLine?"separatorLine":a.logout?"logout":null},items:{resolve:async c=>await expandItems(c.pages,a.reporter,d,b)}}})};function extractSidebarIds(a){function b(a){if(Array.isArray(a)){for(let c of a)b(c);return}a&&"object"==typeof a&&a.pages&&b(a.pages),a&&"object"==typeof a&&(a.page||a.parentPageId)&&c.push(a.page||a.parentPageId)}const c=[];return b(a),c}function filterSerachItems(a=[]){return a.filter(a=>!a.search||(console.warn(chalk.yellow("Search item it not allowed in footer. Skip")),!1))}async function expandItems(a=[],b,c,d){if(!a)return[];const e=d.configPath,f=[];for(const g of a)if(g.page&&(g.page.endsWith("/*")||g.page.endsWith(YAML_PAGE_EXTENSION)||(await isAllowedOasFile(path.resolve(e,g.page)))))f.push(...getExpandedPagesIds(g,b,c));else if(Array.isArray(g.pages))f.push({...g,pages:await expandItems(g.pages,b,c,d)});else if(g.page){const[a]=g.page.split("/*"),d=getPageInfo(a.replace(/^.\//,""));if(!d){b.panicOnBuild(`Could not find page: ${g.page}.`);continue}const e=g.permission||d.permission||c;f.push({...g,permission:e})}else f.push({...g,permission:g.permission||c});return f}function removePrivateSidebarItems(a,b){if(!a)return null;if("development"===process.env.NODE_ENV)return a;if(b)return a;if(a.permission&&a.permission!==RBAC.GUEST_PERMISSION)return null;const c=resolveSidebarItemPermission({...a,permission:a.permission||RBAC.GUEST_PERMISSION});c.items=(c.pages||[]).filter(a=>!a.permission||a.permission===RBAC.GUEST_PERMISSION);const d=JSON.parse(JSON.stringify(c));return filterSidebarItems(d),d.group&&0===d.items.length?void 0:d}function resolveSidebarItemPermission(a){return a.items=a.pages?a.pages.map(resolveSidebarItemPermission):void 0,dfsSidebar(a),a}function dfsSidebar(a){for(const b of a.items||[])dfsSidebar(b);a.permission=a.permission||RBAC.GUEST_PERMISSION}function filterSidebarItems(a){a.items||(a.items=[]);for(let b=0;b<(a.items?a.items.length:[]);b++){if(filterSidebarItems(a.items[b]),a.items[b].permission&&a.items[b].permission!==RBAC.GUEST_PERMISSION){a.items[b]=void 0;continue}if(a.items[b].group&&0===a.items[b].items.filter(a=>void 0!==a&&"separator"!==a.type).length){a.items[b]=void 0;continue}}a.items=a.items.filter(a=>a!==void 0),a.pages=a.items}function getExpandedPagesIds(a,b,c){const{page:d}=a,[e]=d.split("/*"),f=e.replace(/^.\//,""),g=getPageInfo(f),h=d.match(/\/\*$/)||!d.match(/page\.yaml(\/\*)?$/);if(!g&&!h)return b.panicOnBuild(`Page "${d}" is not found. Verify path in "sidebars.yaml"`),[];let i=[];if(!g&&h){for(let{pageId:d,permission:f,type:g,isDefaultApiVersion:h}of getAllPagesInfo())if(d&&d.startsWith(e)){if("redoc-operation"===g)continue;if("redoc-info"===g)continue;if("redoc-redirect"===g){if(!h)continue;const a=getExpandedPagesIds({page:d},b,c);i.push({page:d,pages:a,unwrap:!0});continue}i.push({page:d,permission:f||a.permission||c})}i=i.sort((c,a)=>c.page.localeCompare(a.page,{numeric:!0,sensitivity:"base"})),i=groupPagesByFolder(i,e)}else if(g.redocMenuItems&&g.redocMenuItems.length){const b=[...g.apiVersions].sort(b=>b.isDefault?-1:1),d=b.map(a=>{const b=a.isDefault?"":"@"+a.id;return getPageInfo(f+b)||getPageInfoByDefinitionId(a.definitionId)});for(const b of d){if(!b)debugger;const d=b.redocMenuItems;if(h){if(b.redocInfoPageId)if(a.group){Object.assign(a,{page:b.redocInfoPageId,link:b.link,permission:a.permission||b.permission||c,apiVersionId:b.apiVersionId,isDefaultApiVersion:b.isDefaultApiVersion,pages:d}),i.push(a);continue}else i.push({label:b.label,page:b.redocInfoPageId,link:b.link,permission:a.permission||b.permission||c,apiVersionId:b.apiVersionId,isDefaultApiVersion:b.isDefaultApiVersion});i.push(...d)}else i.push({group:b.label,page:b.redocInfoPageId,pages:d,permission:a.permission||b.permission||c,apiVersionId:b.apiVersionId,isDefaultApiVersion:b.isDefaultApiVersion})}}else h||i.push({page:d,permission:a.permission||g.permission||c});return i}function groupPagesByFolder(a,b){const c={pages:[]},d={};for(let e of a){const{page:a,permission:f,unwrap:g,pages:h}=e,i=a.substring(b.length+1),j=i.split("/");let k=c,l="";for(const a of j.slice(0,-1))l+="/"+a,d[l]?k=d[l]:(d[l]={pages:[],group:a},k.pages.push(d[l]),k=d[l]);g?k.pages.push(...h):k.pages.push({page:a,permission:f})}return c.pages}