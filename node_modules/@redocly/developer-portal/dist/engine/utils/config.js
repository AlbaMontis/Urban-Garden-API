const path=require("path"),fs=require("fs"),{parseYaml}=require("@redocly/openapi-core"),isRelativeUrl=require("is-relative-url"),{getDefaultPermission}=require("../plugins/gatsby-source-redocly-filesystem/rbac"),{replaceEnv}=require("./utils");function readConfig(a){try{const b=replaceEnv(fs.readFileSync(path.resolve(a,"siteConfig.yaml"),"utf8"));let c=parseYaml(b);if(c.meta&&(c.seo={...c.meta,...c.seo},console.warn("[warn] \"meta\" is deprecated in siteConfig.yaml, please rename it to \"seo\"")),c.specs&&(c.oasDefinitions=c.specs),c.oasDefinitions&&c.oasDefinitions.$ref){const b=path.resolve(a,c.oasDefinitions.$ref);try{const a=fs.readFileSync(b,"utf-8");c.oasDefinitions=parseYaml(a);for(const a of Object.keys(c.oasDefinitions))isRelativeUrl(c.oasDefinitions[a])&&(c.oasDefinitions[a]=path.resolve(path.dirname(b),c.oasDefinitions[a]))}catch(a){console.warn("Failed to resolve $ref in siteConfig.yaml -> oasDefinitions: "+a.message)}}return c.footer&&c.footer.columns&&c.footer.columns.some(a=>a.label)&&console.warn(`'label' in footer columns is deprecated. Use 'group' instead`),c.footer&&c.footer.links&&console.warn("footer links are deprecated"),c.defaultRbacPermission=getDefaultPermission(a),!process.env.REDOCLY_DEPLOYMENT_URL||c.seo&&c.seo.siteUrl||(c.seo=c.seo||{},c.seo.siteUrl=process.env.REDOCLY_DEPLOYMENT_URL),c.copyCodeSnippet=c.copyCodeSnippet||{},c}catch(a){"ENOENT"===a.code?(console.log("[error] siteConfig.yaml not found"),process.exit(1)):console.log("[error] failed to load siteConfig.yaml",a)}return{}}function findContentFolder(){return process.env.REDOCLY_TEST_CONTENT_DIR?path.resolve(__dirname,path.join("..","..",process.env.REDOCLY_TEST_CONTENT_DIR)):fs.existsSync(`${__dirname}/../../../../../siteConfig.yaml`)?path.resolve(__dirname,path.join("..","..","..","..","../")):fs.existsSync(`${__dirname}/../../../../../../siteConfig.yaml`)?path.resolve(__dirname,path.join("..","..","..","..","..","../")):fs.existsSync("siteConfig.yaml")?path.resolve("."):fs.existsSync("/site/siteConfig.yaml")?path.resolve("/site"):fs.existsSync("/site/src/siteConfig.yaml")?path.resolve("/site/src"):fs.existsSync(`${__dirname}/../../site/siteConfig.yaml`)?path.resolve(__dirname,path.join("..","..","site/")):fs.existsSync(`${__dirname}/../../../site/siteConfig.yaml`)?path.resolve(__dirname,path.join("..","..","..","site/")):void(reporter.panicOnBuild("[error] content folder not found"),process.exit(1))}module.exports={readConfig,findContentFolder};